<!DOCTYPE >
<html>
	{{> head_tag title="Upcoming Matches"}}
	<body class="min-h-full flex flex-col bg-gray-400">
		{{> header page_name="Upcoming Matches"}}
		<div class="px-4 py-2 flex flex-col flex-grow">
			{{#if user}}
			<div class="w-full flex items-center justify-center">
				<div class="w-4/5 flex flex-col">
					{{#each upcoming_matches}}
					<div class="w-full flex flex-col py-2">
						<div class="flex flex-col text-4xl font-bold">
							<div class="pb-2">{{@key}}</div>
							<hr class="bg-black h-px border-0">
						</div>
						<div class="w-full pt-2">
							{{#each this}}
							<div class="w-full items-center justify-center flex flex-col" id="match.{{team1id}}.{{team2id}}_match">
								<div class="flex flex-row text-center font-bold text-4xl justify-center items-center">
									<img src={{team1image}} style="height: 40px;" class="pr-2">{{team1}} vs {{team2}}<img src={{team2image}} style="height: 40px;" class="pl-2">
								</div>
								<div class="flex flex-row mt-8 py-8">
									<div class="flex flex-row items-center justify-center">
										<div class="px-2 w-1/4 text-right flex items-center justify-center" id="match.{{team1id}}.{{team2id}}_team1">
											{{team1}}
										</div>
										<div class="px-2" style="width: 300px">
											<div id="match.{{team1id}}.{{team2id}}_slider" style="height: 1px; top:38px;" class="flex items-center justify-center w-full"></div>
											<div class="relative px-px text-center text-xs text-gray-300 select-none" style="top:27.5px">|</div>
											<div class="relative w-full px-px text-center flex flex-col items-center justify-center select-none">
												<div class="relative text-2xl w-1/2 items-center justify-center" style="top:2.5px; left:{{find_left average_guess}}%">
													<div>|</div>
												</div>
											</div>
											<div class="relative w-full px-px text-center flex flex-col items-center justify-center select-none">
												<div class="relative flex flex-col w-1/2 items-center justify-center" style="left:{{find_left average_guess}}%">
													<div>{{display_average average_guess}}%</div>
													<div>Average Guess</div>
												</div>
											</div>
										</div>
										<div class="px-2 w-1/4 text-left flex items-center justify-center" id="match.{{team1id}}.{{team2id}}_team2">
											{{team2}}
										</div>
									</div>
									<div class="pl-6 flex flex-col items-center justify-center" style="width: 400px;">
										<div class="w-full">
											You'll <span id="match.{{team1id}}.{{team2id}}_team1_text">gain</span> <span id="match.{{team1id}}.{{team2id}}_team1_points" class="text-lg font-bold">0.0</span> points if <span id="match.{{team1id}}.{{team2id}}_team1_name">{{team1}}</span> wins.
										</div>
										<div class="w-full">
											You'll <span id="match.{{team1id}}.{{team2id}}_team2_text">gain</span> <span id="match.{{team1id}}.{{team2id}}_team2_points" class="text-lg font-bold">0.0</span> points if <span id="match.{{team1id}}.{{team2id}}_team2_name">{{team2}}</span> wins.
										</div>
									</div>
								</div>
							</div>
							{{/each}}
						</div>
					</div>
					{{/each}}
				</div>
			</div>
			{{else}}
			<div class="w-full flex justify-center items-center text-3xl font-bold">
				Please <a href="/auth/steam"><img src="imgs/steam_login.png" class="px-3"></a> to predict matches.
			</div>
			{{/if}}
		</div>
		{{> footer}}
    </body>
	<script>
		{{#each upcoming_matches}}
			{{#each this}}
				let match_{{replace_invalid_char team1}}_{{replace_invalid_char team2}}_slider = document.getElementById('match.{{team1id}}.{{team2id}}_slider');
				noUiSlider.create(match_{{replace_invalid_char team1}}_{{replace_invalid_char team2}}_slider, {
					start: {{your_guess}},
					step: 1,
					range: {
						'min': 0,
						'max': 100
					},
					tooltips: {
						to: function(val) {
							let display_val = val
							if (val < 50) {
								display_val = 100 - val
							}
							return `<div class="flex flex-col bg-transparent items-center justify-center text-center"><div class="font-semibold">Your guess:<div class="flex flex-col items-center justify-center text-center"><div class="flex flex-row"><div style="width:13.45px"></div><div class="font-bold text-4xl">${Math.round(display_val)}</div><div>%</div></div></div>`
						}
					},
				});
				match_{{replace_invalid_char team1}}_{{replace_invalid_char team2}}_slider.noUiSlider.on('update', function (values, handle) {
					change_score(match_{{replace_invalid_char team1}}_{{replace_invalid_char team2}}_slider.id)
				})
				match_{{replace_invalid_char team1}}_{{replace_invalid_char team2}}_slider.noUiSlider.on('end', function (values, handle) {
					post_score(match_{{replace_invalid_char team1}}_{{replace_invalid_char team2}}_slider.id)
				})
			{{/each}}
		{{/each}}

		function post_score(id) {
			const match_num = id.substring(0, id.indexOf("_"))
			const prob = parseInt(document.getElementById(id).noUiSlider.get())

			let request = new XMLHttpRequest();
			request.open('POST', '/insert_guess');
			request.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

			const team1id = id.substring(6, id.indexOf(".", 6))
			const team2id = id.substring(id.indexOf(".", 6)+1, id.indexOf("_"))

			console.log(team1id, team2id)

			request.responseType = 'json';
			request.send(`team1id=${team1id}&team2id=${team2id}&guess=${prob}`);
		}

		function change_score(id) {
			const match_num = id.substring(0, id.indexOf("_"))
			const prob = parseInt(document.getElementById(id).noUiSlider.get())
			let team1_probs = (100-prob).toFixed(1)
			let team2_probs = prob.toFixed(1)

			if (prob < 50) {
				team1_probs = (100-prob).toFixed(1)
				team2_probs = prob.toFixed(1)
			}

			const team1_score = calc_score(team1_probs)
			const team2_score = calc_score(team2_probs)

			if (team1_score < 0) {
				document.getElementById(`${match_num}_team1_text`).innerHTML = "lose"
				document.getElementById(`${match_num}_team1_points`).classList.remove("text-green-700")
				document.getElementById(`${match_num}_team1_points`).classList.add("text-red-700")
				document.getElementById(`${match_num}_team1_points`).innerHTML = Math.abs(team1_score).toFixed(1)
				document.getElementById(`${match_num}_team1_name`).classList.remove("font-bold")
				document.getElementById(`${match_num}_team1`).classList.remove("font-bold")

				document.getElementById(`${match_num}_team2_text`).innerHTML = "gain"
				document.getElementById(`${match_num}_team2_points`).classList.remove("text-red-700")
				document.getElementById(`${match_num}_team2_points`).classList.add("text-green-700")
				document.getElementById(`${match_num}_team2_points`).innerHTML = Math.abs(team2_score).toFixed(1)
				document.getElementById(`${match_num}_team2_name`).classList.add("font-bold")
				document.getElementById(`${match_num}_team2`).classList.add("font-bold")
			}
			else if (team1_score > 0) {
				document.getElementById(`${match_num}_team1_text`).innerHTML = "gain"
				document.getElementById(`${match_num}_team1_points`).classList.add("text-green-700")
				document.getElementById(`${match_num}_team1_points`).classList.remove("text-red-700")
				document.getElementById(`${match_num}_team1_points`).innerHTML = Math.abs(team1_score).toFixed(1)
				document.getElementById(`${match_num}_team1_name`).classList.add("font-bold")
				document.getElementById(`${match_num}_team1`).classList.add("font-bold")

				document.getElementById(`${match_num}_team2_text`).innerHTML = "lose"
				document.getElementById(`${match_num}_team2_points`).classList.add("text-red-700")
				document.getElementById(`${match_num}_team2_points`).classList.remove("text-green-700")
				document.getElementById(`${match_num}_team2_points`).innerHTML = Math.abs(team2_score).toFixed(1)
				document.getElementById(`${match_num}_team2_name`).classList.remove("font-bold")
				document.getElementById(`${match_num}_team2`).classList.remove("font-bold")
			}
			else {
				document.getElementById(`${match_num}_team1_text`).innerHTML = "gain"
				document.getElementById(`${match_num}_team1_points`).classList.remove("text-green-700", "text-red-700")
				document.getElementById(`${match_num}_team1_points`).innerHTML = "0.0"
				document.getElementById(`${match_num}_team1_name`).classList.remove("font-bold")
				document.getElementById(`${match_num}_team1`).classList.remove("font-bold")

				document.getElementById(`${match_num}_team2_text`).innerHTML = "gain"
				document.getElementById(`${match_num}_team2_points`).classList.remove("text-green-700", "text-red-700")
				document.getElementById(`${match_num}_team2_points`).innerHTML = "0.0"
				document.getElementById(`${match_num}_team2_name`).classList.remove("font-bold")
				document.getElementById(`${match_num}_team2`).classList.remove("font-bold")
			}
		}
		function calc_score(prob) {
			return 25 - (Math.pow(prob - 100, 2) / 100)
		}
	</script>
</html>
